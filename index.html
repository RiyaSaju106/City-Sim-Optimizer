<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>City Sim Optimizer</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    body{margin:0;display:flex;height:100vh;font-family:Arial,sans-serif;}
    #panel{width:380px;padding:16px;background:#fff;box-shadow:2px 0 6px rgba(0,0,0,0.1);overflow:auto;}
    #map{flex:1;}
    h2{margin-top:0;}
    .control{margin-bottom:16px;}
    label{font-weight:bold;display:block;margin-bottom:6px;}
    input[type=range]{width:100%;}
    .value{margin-left:6px;font-weight:bold;}
    #emojiMeter{display:flex;align-items:center;gap:10px;margin-top:12px;padding:10px;background:#f9f9f9;border-radius:8px;}
    #bigEmoji{font-size:56px;transition:transform .2s ease;}
    #healthBar{flex:1;height:14px;background:#eee;border-radius:8px;overflow:hidden;}
    #healthFill{height:100%;width:0%;background:#2ecc71;transition:width .3s ease,background .3s ease;}
    #healthLabel{font-weight:bold;margin-bottom:4px;}
    .small{font-size:12px;color:#555;}
    #suggestions{margin-top:16px;padding:10px;background:#f4f9ff;border-radius:8px;border-left:4px solid #3498db;}
    #suggestions h3{margin:0 0 8px;font-size:16px;color:#3498db;}
    #suggestionList ul, #suggestionList{margin:0;padding-left:20px;}
    #searchBox{display:flex;gap:8px;margin-bottom:16px;}
    #searchBox input{flex:1;padding:6px;border:1px solid #ccc;border-radius:4px;}
    #searchBox button{padding:6px 12px;background:#3498db;color:#fff;border:none;border-radius:4px;cursor:pointer;}
    #searchBox button:hover{background:#2980b9;}
    #eventPanel{display:flex;gap:8px;margin-bottom:16px;flex-wrap:wrap;}
    #eventPanel button{padding:6px 12px;background:#e67e22;color:#fff;border:none;border-radius:4px;cursor:pointer;}
    #eventPanel button:hover{background:#c0392b;}
    #reportForm{margin-top:18px;padding:10px;background:#fbeee6;border-radius:8px;border-left:4px solid #e67e22;}
    #reportForm h3{margin-top:0;color:#e67e22;}
    #reportList{margin-top:10px;}
    #scenarioPanel{margin-top:18px;padding:10px;background:#eafcff;border-radius:8px;border-left:4px solid #2ecc71;}
    #scenarioPanel h3{margin-top:0;color:#2ecc71;}
    #scenarioList{font-size:13px;}
    #compareBtn{margin-top:10px;padding:6px 12px;background:#3498db;color:#fff;border:none;border-radius:4px;cursor:pointer;}
    #compareBtn:hover{background:#2980b9;}
    .pin{color:#e74c3c;font-weight:bold;}
  </style>
</head>
<body>
  <div id="panel">
    <h2>City Sim Optimizer üåÜ</h2>
    <p class="small">Sliders control stress; pick a location, simulate events, or report issues. Compare scenarios instantly!</p>

    <div id="searchBox">
      <input id="cityInput" type="text" placeholder="Enter city or street (e.g. Koramangala)">
      <button onclick="searchCity()">Go</button>
    </div>

    <div id="eventPanel">
      <button onclick="simulateEvent('festival')">Festival</button>
      <button onclick="simulateEvent('rain')">Rain</button>
      <button onclick="simulateEvent('trafficjam')">Traffic Jam</button>
      <button onclick="simulateEvent('normal')">Normal</button>
      <button onclick="fetchLiveTraffic()">Fetch Live Traffic üö¶</button>
      <button onclick="fetchNanoSensor()">Nano Traffic Sensor üì°</button>
    </div>

    <div class="control">
      <label>Traffic multiplier <span id="trafficVal" class="value">1.0√ó</span></label>
      <input id="traffic" type="range" min="0.5" max="3.0" step="0.1" value="1.0">
    </div>

    <div class="control">
      <label>Waste fill (%) <span id="wasteVal" class="value">25%</span></label>
      <input id="waste" type="range" min="0" max="100" step="1" value="25">
    </div>

    <div class="control">
      <label>Water shortage (%) <span id="waterVal" class="value">30%</span></label>
      <input id="water" type="range" min="0" max="100" step="1" value="30">
    </div>

    <div id="emojiMeter">
      <div id="bigEmoji">üòÉ</div>
      <div style="flex:1">
        <div id="healthLabel">Health: <span id="healthNum">84</span>%</div>
        <div id="healthBar"><div id="healthFill"></div></div>
        <div class="small" id="healthHint">All good ‚Äî keep monitoring ‚úÖ</div>
      </div>
    </div>

    <div id="suggestions">
      <h3>AI Suggestions ü§ñ</h3>
      <ul id="suggestionList"><li>Loading...</li></ul>
    </div>

    <div id="reportForm">
      <h3>Report an Issue</h3>
      <label for="reportText">Describe problem:</label>
      <input id="reportText" type="text" style="width:100%;" placeholder="E.g. Water cut, traffic jam...">
      <button onclick="submitReport()" style="margin-top:8px;background:#e67e22;">Report</button>
      <ul id="reportList"></ul>
    </div>

    <div id="scenarioPanel">
      <h3>Scenario Save & Compare</h3>
      <button onclick="saveScenario()">Save Current Scenario</button>
      <ul id="scenarioList"></ul>
      <button id="compareBtn" onclick="compareScenarios()">Compare All Saved</button>
      <div id="compareResult" class="small"></div>
      <div id="routePanel" style="margin-top:18px;padding:10px;background:#fff8e6;border-radius:8px;border-left:4px solid #f39c12;">
        <h3>Shortest Route üöó</h3>
        <input id="startInput" type="text" placeholder="Enter start location" style="width:100%;margin-bottom:6px;">
        <button onclick="findShortestRoute()" style="background:#f39c12;color:#fff;border:none;padding:6px 12px;border-radius:4px;cursor:pointer;">Find Route</button>
        <div id="routeInfo" class="small" style="margin-top:8px;"></div>
      </div>
    </div>
  </div>

  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>
  <script>
    // ----------------- ORIGINAL CONFIG -----------------
    const CONFIG = {
      trafficMin: 0.5, trafficMax: 3.0,
      weights: { traffic:0.5, waste:0.3, water:0.2 },
      thresholds: [
        {min:80,emoji:'üòÉ',text:'Excellent ‚Äî smooth & sustainable!'},
        {min:60,emoji:'üôÇ',text:'Good ‚Äî manageable.'},
        {min:40,emoji:'üòê',text:'Okay ‚Äî needs care.'},
        {min:20,emoji:'üòü',text:'Poor ‚Äî take action.'},
        {min:0,emoji:'üíÄ',text:'Critical ‚Äî crisis level!'}
      ],
      center:[12.9716,77.5946], zoom:12,
      events: {
        festival: {traffic:2.5, waste:70, water:40},
        rain: {traffic:1.8, waste:40, water:60},
        trafficjam: {traffic:3.0, waste:30, water:30},
        normal: {traffic:1.0, waste:25, water:30},
      }
    };

    const map=L.map('map').setView(CONFIG.center,CONFIG.zoom);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    let healthCircle=L.circle(CONFIG.center,{radius:200,color:'#2ecc71',fillOpacity:0.12}).addTo(map);

    // ----------------- SLIDERS & UI -----------------
    const trafficSlider=document.getElementById('traffic');
    const wasteSlider=document.getElementById('waste');
    const waterSlider=document.getElementById('water');
    const trafficVal=document.getElementById('trafficVal');
    const wasteVal=document.getElementById('wasteVal');
    const waterVal=document.getElementById('waterVal');
    const bigEmoji=document.getElementById('bigEmoji');
    const healthNum=document.getElementById('healthNum');
    const healthFill=document.getElementById('healthFill');
    const healthHint=document.getElementById('healthHint');
    const suggestionList=document.getElementById('suggestionList');
    const reportList=document.getElementById('reportList');
    const scenarioList=document.getElementById('scenarioList');
    const compareResult=document.getElementById('compareResult');
    const routeInfo=document.getElementById('routeInfo');

    let reports=[]; 
    let scenarios=[];

    function clamp(v,a=0,b=1){return Math.min(b,Math.max(a,v));}
    function normalizeTraffic(v){return clamp((v-CONFIG.trafficMin)/(CONFIG.trafficMax-CONFIG.trafficMin));}
    function normalizeWaste(v){return clamp(v/100);}
    function normalizeWater(v){return clamp(v/100);}
    function computeHealth(t,w,water){
      const nT=normalizeTraffic(t), nW=normalizeWaste(w), nH=normalizeWater(water);
      const weights=CONFIG.weights; const sum=weights.traffic+weights.waste+weights.water;
      const p=(weights.traffic/sum)*nT+(weights.waste/sum)*nW+(weights.water/sum)*nH;
      return Math.round(clamp(1-p)*100);
    }
    function chooseEmoji(h){return CONFIG.thresholds.find(th=>h>=th.min)||CONFIG.thresholds.slice(-1)[0];}

    function updateSuggestionsLive(){
      const t=parseFloat(trafficSlider.value);
      const w=parseFloat(wasteSlider.value);
      const h=parseFloat(waterSlider.value);
      let suggestions=[];
      if(t>2.0)suggestions.push("Deploy traffic police and reroute vehicles.");
      if(w>60)suggestions.push("Increase waste truck frequency and setup temporary bins.");
      if(h>50)suggestions.push("Announce water-saving measures and deploy tankers.");
      if(suggestions.length===0)suggestions.push("All systems stable. Monitor regularly.");
      suggestionList.innerHTML='';
      suggestions.forEach(s=>{const li=document.createElement('li'); li.textContent=s; suggestionList.appendChild(li);});
    }

    function updateHealthCircleColor(health){
      let color='#2ecc71';
      if(health>=80) color='#2ecc71';
      else if(health>=60) color='#7bd389';
      else if(health>=40) color='#f1c40f';
      else if(health>=20) color='#e67e22';
      else color='#e74c3c';
      healthFill.style.background=color;
      healthCircle.setStyle({color, fillColor:color});
      healthCircle.setRadius(500*(1-health/100)+80);
    }

    const roadSegments = [
      {coords: [[12.9716,77.5946],[12.975,77.6]], traffic: Math.random()+0.5}, 
      {coords: [[12.9716,77.5946],[12.965,77.59]], traffic: Math.random()+0.5},
      {coords: [[12.975,77.6],[12.980,77.605]], traffic: Math.random()+0.5},
      {coords: [[12.965,77.59],[12.960,77.585]], traffic: Math.random()+0.5}    
    ];
    const roadLayer = roadSegments.map(seg=>L.polyline(seg.coords, {color:'green',weight:6,opacity:0.6}).addTo(map));
    function updateRoadColorsDynamic(trafficMultiplier){
      roadSegments.forEach((seg,i)=>{
        let color = 'green';
        const level = seg.traffic * trafficMultiplier;
        if(level > 2.5) color='red';
        else if(level > 1.5) color='orange';
        else color='green';
        roadLayer[i].setStyle({color});
      });
    }

    function updateUI(){
      const t=parseFloat(trafficSlider.value), w=parseFloat(wasteSlider.value), h2=parseFloat(waterSlider.value);
      trafficVal.textContent=t.toFixed(1)+'√ó'; wasteVal.textContent=w+'%'; waterVal.textContent=h2+'%';
      const health=computeHealth(t,w,h2);
      healthNum.textContent=health; healthFill.style.width=health+'%';
      const th=chooseEmoji(health); bigEmoji.textContent=th.emoji; healthHint.textContent=th.text;
      updateHealthCircleColor(health);
      bigEmoji.style.transform='scale(1.1)'; setTimeout(()=>bigEmoji.style.transform='scale(1)',150);
      updateSuggestionsLive();
      updateRoadColorsDynamic(t);
    }

    [trafficSlider,wasteSlider,waterSlider].forEach(s=>s.addEventListener('input',updateUI));
    updateUI();

    map.on('click', e=>{healthCircle.setLatLng(e.latlng); map.panTo(e.latlng);});

    // ----------------- HEATMAP ADD-ON -----------------
    let heatLayer;
    async function updateHeatmap(lat, lon){
      if(heatLayer){map.removeLayer(heatLayer);}
      try{
        const res = await fetch(`http://127.0.0.1:5000/tomtom-traffic-bbox?lat=${lat}&lon=${lon}`);
        const data = await res.json();
        if(data.points && data.points.length > 0){
          const heatPoints = data.points.map(p => [p.lat, p.lon, p.intensity]);
          heatLayer = L.heatLayer(heatPoints, {radius:25, blur:15, maxZoom:17}).addTo(map);
        }
      } catch(err){console.error("Heatmap fetch error", err);}
    }

    async function searchCity(){
      const city=document.getElementById('cityInput').value.trim();
      if(!city)return;
      try{
        const url=`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(city)}`;
        const res=await fetch(url); const data=await res.json();
        if(data.length>0){
          const {lat,lon}=data[0]; const newPos=[parseFloat(lat),parseFloat(lon)];
          map.setView(newPos,16); healthCircle.setLatLng(newPos);
          updateHeatmap(parseFloat(lat),parseFloat(lon));
        }else{alert("City not found ‚ùå");}
      }catch(err){alert("Error fetching city location");}
    }

    function simulateEvent(type){
      const preset=CONFIG.events[type];
      if(preset){trafficSlider.value=preset.traffic; wasteSlider.value=preset.waste; waterSlider.value=preset.water; updateUI();}
    }

    function submitReport(){
      const txt=document.getElementById('reportText').value.trim();
      if(!txt)return;
      const latlng=healthCircle.getLatLng();
      reports.push({text:txt,lat:latlng.lat,lng:latlng.lng});
      renderReports(); addReportPin(txt,latlng); document.getElementById('reportText').value="";
    }

    function renderReports(){
      reportList.innerHTML="";
      reports.slice(-5).reverse().forEach(r=>{
        const li=document.createElement('li'); 
        li.textContent=`${r.text} at [${r.lat.toFixed(3)}, ${r.lng.toFixed(3)}]`;
        reportList.appendChild(li);
      });
    }

    function addReportPin(text,latlng){
      const pin=L.marker(latlng).addTo(map);
      pin.bindPopup(`<span class="pin">üìç Citizen Report:</span> ${text}`).openPopup();
      setTimeout(()=>{map.closePopup();},3000);
    }

    function saveScenario(){
      const t=parseFloat(trafficSlider.value),w=parseFloat(wasteSlider.value),h=parseFloat(waterSlider.value);
      const health=computeHealth(t,w,h); scenarios.push({t,w,h,health}); renderScenarios();
    }

    function renderScenarios(){
      scenarioList.innerHTML="";
      scenarios.forEach((s,i)=>{
        const li=document.createElement('li');
        li.textContent=`#${i+1}: Traffic ${s.t}√ó, Waste ${s.w}%, Water ${s.h}% ‚Üí Health ${s.health}%`;
        scenarioList.appendChild(li);
      });
    }

    function compareScenarios(){
      if(scenarios.length<2){compareResult.textContent="Save at least two scenarios to compare."; return;}
      let best=scenarios.reduce((a,b)=>a.health>=b.health?a:b);
      let worst=scenarios.reduce((a,b)=>a.health<=b.health?a:b);
      compareResult.textContent=`Best: Health ${best.health}%. Worst: Health ${worst.health}%.`;
    }

    async function fetchLiveTraffic(){
      const center = map.getCenter();
      try {
        const url = `http://127.0.0.1:5000/tomtom-traffic?lat=${center.lat}&lon=${center.lng}`;
        const res = await fetch(url);
        const data = await res.json();
        if(data.flowSegmentData){
          const freeFlow = data.flowSegmentData.freeFlowSpeed || 50;
          const current = data.flowSegmentData.currentSpeed || freeFlow;
          const multiplier = freeFlow / current;
          roadSegments.forEach(seg => { seg.traffic = Math.min(Math.max(multiplier, 0.5), 3.0); });
          updateRoadColorsDynamic(parseFloat(trafficSlider.value));
          alert('Live traffic updated ‚úÖ');
        } else { alert('No live traffic data for this area ‚ùå'); }
      } catch(err){ console.error('Traffic fetch error', err); alert('Error fetching live traffic ‚ùå'); }
    }

    async function fetchNanoSensor(){
      try {
        const res = await fetch(`http://127.0.0.1:5000/nano-sensor`);
        const data = await res.json();
        alert(`Nano/Banana Pi Traffic Count: ${data.traffic_count} cars (source: ${data.source})`);
        if (data.traffic_count > 3) {
          trafficSlider.value = 3.0; // max traffic
        } else {
          trafficSlider.value = 1.0 + data.traffic_count * 0.5;
        }
        updateUI();
      } catch(err){
        alert("Failed to fetch Nano sensor data ‚ùå");
      }
    }

    // ----------------- SHORTEST ROUTE FEATURE -----------------
    let routeLayer;
    async function findShortestRoute(){
      const start=document.getElementById('startInput').value.trim();
      routeInfo.textContent = "";
      if(!start){alert("Enter a start location"); return;}
      try{
        // Geocode start location
        const res=await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(start)}`);
        const data=await res.json();
        if(data.length===0){alert("Start location not found ‚ùå"); return;}
        const startLat=parseFloat(data[0].lat), startLon=parseFloat(data[0].lon);

        // Destination = healthCircle
        const dest=healthCircle.getLatLng();

        // Fetch route from OSRM
        const url=`https://router.project-osrm.org/route/v1/driving/${startLon},${startLat};${dest.lng},${dest.lat}?overview=full&geometries=geojson&steps=true`;
        const routeRes=await fetch(url);
        const routeData=await routeRes.json();

        if(routeData.routes && routeData.routes.length>0){
          const route = routeData.routes[0];
          const coords=route.geometry.coordinates.map(c=>[c[1],c[0]]);
          if(routeLayer) map.removeLayer(routeLayer);
          routeLayer=L.polyline(coords,{color:'blue',weight:5}).addTo(map);
          map.fitBounds(routeLayer.getBounds());
          // Show route info
          let info = `‚úÖ <b>Distance:</b> ${(route.distance/1000).toFixed(2)} km<br>`;
          info += `<b>Estimated time:</b> ${Math.round(route.duration/60)} min<br>`;
          if(route.legs && route.legs[0] && route.legs[0].steps) {
            info += "<b>Directions:</b><ol style='margin:0;padding-left:16px;font-size:12px'>";
            route.legs[0].steps.slice(0,6).forEach((step,i)=>{
              info += `<li>${step.maneuver.instruction || step.name || "Continue"}</li>`;
            });
            if(route.legs[0].steps.length>6) info += `<li>...and ${route.legs[0].steps.length-6} more steps</li>`;
            info += "</ol>";
          }
          routeInfo.innerHTML = info;
        } else {
          alert("No route found ‚ùå");
          routeInfo.textContent = "No route found.";
        }
      }catch(err){
        console.error(err); 
        alert("Error fetching route ‚ùå");
        routeInfo.textContent = "Route fetch failed.";
      }
    }
  </script>
</body>
</html>